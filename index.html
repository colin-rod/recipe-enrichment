<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recipe Enrichment Dashboard</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #fafafa;
            color: #37352f;
            line-height: 1.6;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 24px;
        }
        
        .header {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 16px;
            border: 1px solid #e9e9e7;
            box-shadow: 0 1px 3px rgba(15, 15, 15, 0.1);
        }
        
        .header h1 {
            font-size: 1.75rem;
            font-weight: 700;
            color: #2f1b14;
            margin-bottom: 4px;
        }
        
        .header p {
            color: #787774;
            font-size: 0.875rem;
        }
        
        .top-section {
            background: white;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #e9e9e7;
            box-shadow: 0 1px 3px rgba(15, 15, 15, 0.1);
        }
        
        .header-stat {
            text-align: center;
            margin-bottom: 16px;
        }
        
        .recipes-count {
            font-size: 2rem;
            font-weight: 700;
            color: #2f1b14;
            margin-right: 8px;
        }
        
        .recipes-label {
            color: #787774;
            font-size: 1rem;
            font-weight: 500;
        }
        
        .controls {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .recipe-card {
            background: white;
            border-radius: 8px;
            margin-bottom: 24px;
            overflow: hidden;
            border: 2px solid #e9e9e7;
            box-shadow: 0 4px 12px rgba(15, 15, 15, 0.15);
            transition: box-shadow 0.2s ease;
        }
        
        .recipe-card:hover {
            box-shadow: 0 6px 20px rgba(15, 15, 15, 0.2);
        }
        
        .recipe-header {
            background: #f7f6f3;
            border-bottom: 1px solid #e9e9e7;
            padding: 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .recipe-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #2f1b14;
            margin: 0;
        }
        
        .confidence-badge {
            padding: 4px 12px;
            border-radius: 4px;
            font-size: 0.875rem;
            font-weight: 500;
            background: #e9e9e7;
            color: #787774;
        }
        
        .recipe-body {
            padding: 24px;
        }
        
        .recipe-details {
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid #e9e9e7;
        }
        
        .recipe-details p {
            margin-bottom: 8px;
            color: #787774;
            font-size: 0.875rem;
        }
        
        .recipe-details strong { 
            color: #37352f; 
        }
        
        .recipe-details a {
            color: #2383e2;
            text-decoration: none;
        }
        
        .recipe-details a:hover {
            text-decoration: underline;
        }
        
        /* Three-column layout */
        .comparison-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 24px;
            margin-bottom: 24px;
        }
        
        .column {
            background: #fafafa;
            border: 1px solid #e9e9e7;
            border-radius: 6px;
            padding: 16px;
        }
        
        .column h4 {
            font-size: 0.875rem;
            font-weight: 600;
            color: #2f1b14;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .current-column h4 { color: #787774; }
        .suggested-column h4 { color: #2383e2; }
        .final-column h4 { color: #448361; }
        
        .field-group {
            margin-bottom: 16px;
        }
        
        .field-label {
            font-size: 0.75rem;
            font-weight: 500;
            color: #787774;
            margin-bottom: 4px;
            display: block;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .field-value {
            font-size: 0.875rem;
            color: #37352f;
            min-height: 20px;
        }
        
        .field-value.empty {
            color: #9b9a97;
            font-style: italic;
        }
        
        .text-value {
            max-height: 120px;
            overflow-y: auto;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 4px;
            font-size: 0.875rem;
            line-height: 1.4;
        }
        
        .tag-list {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
        }
        
        .tag {
            background: #e9e9e7;
            color: #37352f;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        
        .suggested-column .tag {
            background: #2383e2;
            color: white;
        }
        
        .final-column .tag {
            background: #448361;
            color: white;
        }
        
        /* Image gallery */
        .image-section {
            margin-bottom: 24px;
            padding: 20px;
            background: #fafafa;
            border: 1px solid #e9e9e7;
            border-radius: 6px;
        }
        
        .image-section h4 {
            font-size: 1rem;
            font-weight: 600;
            color: #2f1b14;
            margin-bottom: 16px;
        }
        
        .image-gallery {
            display: flex;
            gap: 16px;
            overflow-x: auto;
            padding-bottom: 12px;
            margin-bottom: 16px;
        }
        
        .image-option {
            flex-shrink: 0;
            width: 160px;
            height: 120px;
            border: 2px solid transparent;
            border-radius: 6px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }
        
        .upload-area {
            border: 2px dashed #d9d7d4;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            cursor: pointer;
        }
        
        .upload-area:hover {
            border-color: #2383e2;
            background: #f7f6f3;
        }
        
        .upload-area.dragover {
            border-color: #2383e2;
            background: #f0f4ff;
        }
        
        .upload-content {
            text-align: center;
            padding: 20px 10px;
        }
        
        .upload-icon {
            display: block;
            font-size: 1.5rem;
            margin-bottom: 4px;
        }
        
        .upload-text {
            font-size: 0.75rem;
            color: #787774;
            font-weight: 500;
        }
        
        .url-input-section {
            margin-top: 12px;
        }
        
        .url-input-group {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        
        .image-url-input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #e9e9e7;
            border-radius: 4px;
            font-size: 0.875rem;
        }
        
        .add-image-btn {
            background: #2383e2;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.875rem;
            margin-top: 8px;
        }
        
        .add-image-btn:hover {
            background: #1a73d1;
        }
        
        .image-option:hover {
            border-color: #2383e2;
            transform: scale(1.02);
        }
        
        .image-option.selected {
            border-color: #448361;
            box-shadow: 0 0 0 2px rgba(68, 131, 97, 0.2);
        }

        /* Structured recipe components */
        .recipe-header-info {
            background: #f7f6f3;
            padding: 16px;
            border-radius: 6px;
            margin-bottom: 16px;
            border: 1px solid #e9e9e7;
        }

        .recipe-meta {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 12px;
            margin-top: 12px;
        }

        .meta-item {
            text-align: center;
            padding: 8px;
            background: white;
            border-radius: 4px;
            border: 1px solid #e9e9e7;
        }

        .meta-label {
            font-size: 0.75rem;
            color: #787774;
            text-transform: uppercase;
            font-weight: 600;
            margin-bottom: 2px;
        }

        .meta-value {
            font-size: 0.875rem;
            font-weight: 600;
            color: #2f1b14;
        }
















        .edit-toggle-btn:hover {
            border-color: #2383e2;
            color: #2383e2;
        }

        .edit-mode textarea {
            width: 100%;
            min-height: 120px;
            padding: 12px;
            border: 1px solid #d9d7d4;
            border-radius: 4px;
            font-size: 0.875rem;
            line-height: 1.4;
            resize: vertical;
            font-family: inherit;
        }

        .edit-mode textarea:focus {
            border-color: #2383e2;
            outline: none;
            box-shadow: 0 0 0 2px rgba(35, 131, 226, 0.1);
        }
        
        .image-option:hover {
            border-color: #2383e2;
            transform: translateY(-1px);
        }
        
        .image-option.selected:hover {
            border-color: #e53e3e;
            box-shadow: 0 0 0 2px rgba(229, 62, 62, 0.3);
            cursor: pointer;
        }
        
        .image-option img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .image-option .placeholder {
            width: 100%;
            height: 100%;
            background: #e9e9e7;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #9b9a97;
            font-size: 0.75rem;
            text-align: center;
        }
        
        .selected-badge {
            position: absolute;
            top: 4px;
            right: 4px;
            background: #448361;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 600;
        }
        
        /* Action buttons */
        .card-notification {
            padding: 12px 20px;
            margin: 0;
            border-radius: 0;
            text-align: center;
            font-weight: 500;
            display: none;
        }
        
        .card-notification.success {
            background: #d1f2d1;
            color: #2d5a2d;
            border-left: 4px solid #4caf50;
        }
        
        .card-notification.error {
            background: #fde8e8;
            color: #c53030;
            border-left: 4px solid #f56565;
        }
        
        .card-notification.info {
            background: #e6f3ff;
            color: #2b6cb0;
            border-left: 4px solid #3182ce;
        }

        .recipe-actions {
            display: flex;
            gap: 12px;
            justify-content: center;
            padding: 24px;
            background: #f7f6f3;
            border-top: 1px solid #e9e9e7;
            flex-wrap: wrap;
        }
        
        .recipe-actions .btn {
            min-width: 160px;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            font-size: 0.875rem;
            transition: all 0.2s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            min-width: 140px;
            justify-content: center;
        }
        
        .btn-primary {
            background: #37352f;
            color: white;
            box-shadow: 0 1px 3px rgba(55, 53, 47, 0.3);
        }
        
        .btn-primary:hover {
            background: #2f2d28;
            transform: translateY(-1px);
            box-shadow: 0 2px 6px rgba(55, 53, 47, 0.4);
        }
        
        .btn-success {
            background: #37352f;
            color: white;
            box-shadow: 0 1px 3px rgba(55, 53, 47, 0.3);
        }
        
        .btn-success:hover {
            background: #2f2d28;
            transform: translateY(-1px);
            box-shadow: 0 2px 6px rgba(55, 53, 47, 0.4);
        }
        
        .btn-secondary {
            background: white;
            color: #787774;
            border: 1px solid #e9e9e7;
        }
        
        .btn-secondary:hover {
            background: #f7f6f3;
            border-color: #d9d7d4;
            color: #37352f;
            transform: translateY(-1px);
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }
        
        .loading {
            text-align: center;
            padding: 60px;
            color: #787774;
        }
        
        .spinner {
            border: 3px solid #e9e9e7;
            border-top: 3px solid #2383e2;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .empty-state {
            text-align: center;
            padding: 80px 20px;
            color: #787774;
            background: white;
            border-radius: 8px;
            border: 1px solid #e9e9e7;
        }
        
        .alert {
            background: white;
            border-radius: 6px;
            padding: 16px;
            margin-bottom: 16px;
            border-left: 4px solid #448361;
            color: #37352f;
        }
        
        .alert.error { 
            border-left-color: #e03e3e; 
            background: #fef5f5;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .comparison-grid { 
                grid-template-columns: 1fr; 
            }
            .controls { 
                flex-direction: column; 
                align-items: stretch; 
            }
            .recipe-actions { 
                flex-direction: column; 
            }
            .btn {
                min-width: auto;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Recipe Enrichment Dashboard</h1>
            <p>AI-powered recipe categorization and enhancement</p>
        </div>

        <div class="top-section">
            <div class="header-stat">
                <span class="recipes-count" id="totalRecipes">-</span>
                <span class="recipes-label">recipes to review</span>
            </div>

            <div class="controls">
                <button class="btn btn-primary" onclick="refreshNotionData()">📋 Refresh from Notion</button>
                <button class="btn btn-primary" onclick="refreshWebsiteData()">🌐 Refresh from Websites</button>
                <button class="btn btn-primary" onclick="refreshAIAnalysis()">🤖 Refresh AI Analysis</button>
                <button class="btn btn-secondary" onclick="openNotion()">📝 Open Notion</button>
            </div>
        </div>

        <div id="loading" class="loading" style="display: none;">
            <div class="spinner"></div>
            <p>Processing recipes...</p>
        </div>

        <div id="alert" class="alert" style="display: none;"></div>

        <div id="recipeContainer"></div>

        <div id="emptyState" class="empty-state" style="display: none;">
            <h3>🎉 All Set!</h3>
            <p>No recipes need enrichment right now.</p>
        </div>
    </div>

    <script>
        let reviewData = [];
        let selectedImages = {}; // Track selected images for each recipe
        const NOTION_DATABASE_URL = 'https://www.notion.so/1b1ea313dfba4618915c4574ad7ed576';

        // Available options for dropdowns
        const MEAL_OPTIONS = ["Main Dish", "Side Dish", "Breakfast", "Dessert", "Snack", "Beverage"];
        const CUISINE_OPTIONS = ["African", "American", "Asian", "Brazilian", "Chinese", "Dessert", "French", "German", "Greek", "Hungarian", "Indian", "Italian", "Japanese", "Korean", "Mediterranean", "Mexican", "Middle Eastern", "Persian", "Peruvian", "Spanish", "Thai", "Vietnamese"];
        const TAG_OPTIONS = ["Appetizer", "Baked", "Braised", "Breakfast", "Chocolate", "Citrusy", "Condiment", "Creamy", "Curry", "Drink", "Eggs", "Fish", "Grilled", "Herby", "No Bake", "Pasta", "Pickled", "Refreshing", "Roasted", "Salad", "Sandwich", "Savory", "Seafood", "Soup", "Spicy", "Steamed", "Stew", "Stir-Fry", "Sweet", "Tangy", "Traditional", "Vegan", "Vegetarian"];
        const INGREDIENT_OPTIONS = ["Beef", "Chicken", "Pork", "Fish", "Salmon", "Shrimp", "Eggs", "Cheese", "Pasta", "Rice", "Bread", "Potato", "Tomato", "Onions", "Garlic", "Spinach", "Broccoli", "Carrot", "Mushrooms", "Peppers", "Lemon", "Basil", "Herbs", "Ginger", "Chili", "Beans", "Cream", "Milk"];

        document.addEventListener('DOMContentLoaded', loadData);

        // Refresh just the Notion data (get updated recipes from database)
        async function refreshNotionData() {
            showLoading(true, 'Refreshing from Notion...');
            hideAlert();

            try {
                const response = await fetch('/api/enrichment?refresh=notion');
                const result = await response.json();
                
                if (result.success) {
                    reviewData = result.data || [];
                    updateStats(result.stats);
                    processData();
                    showAlert('✅ Refreshed data from Notion!', 'success');
                } else {
                    showAlert('Error refreshing from Notion: ' + result.error, 'error');
                }
            } catch (error) {
                console.error('Notion refresh error:', error);
                let errorMessage = 'Failed to refresh from Notion. ';
                
                if (error.message?.includes('401') || error.message?.includes('Unauthorized')) {
                    errorMessage += 'Please check your Notion API token.';
                } else if (error.message?.includes('network') || error.name === 'NetworkError') {
                    errorMessage += 'Please check your internet connection.';
                } else if (error.message?.includes('timeout')) {
                    errorMessage += 'Request timed out. Please try again.';
                } else {
                    errorMessage += 'Please try again in a few moments.';
                }
                
                showAlert(errorMessage, 'error');
            } finally {
                showLoading(false);
            }
        }

        // Refresh website scraping (re-scrape images and content from recipe URLs)
        async function refreshWebsiteData() {
            showLoading(true, 'Scraping websites for updated content...');
            hideAlert();

            try {
                const response = await fetch('/api/enrichment?refresh=website');
                const result = await response.json();
                
                if (result.success) {
                    reviewData = result.data || [];
                    updateStats(result.stats);
                    processData();
                    showAlert('✅ Refreshed content from recipe websites!', 'success');
                } else {
                    showAlert('Error scraping websites: ' + result.error, 'error');
                }
            } catch (error) {
                console.error('Website refresh error:', error);
                showAlert('Failed to refresh from websites. Please try again.', 'error');
            } finally {
                showLoading(false);
            }
        }

        // Refresh AI analysis (re-run GPT analysis on existing data)
        async function refreshAIAnalysis() {
            showLoading(true, 'Re-running AI analysis...');
            hideAlert();

            try {
                const response = await fetch('/api/enrichment?refresh=ai');
                const result = await response.json();
                
                if (result.success) {
                    reviewData = result.data || [];
                    updateStats(result.stats);
                    processData();
                    showAlert('✅ Refreshed AI analysis!', 'success');
                } else {
                    showAlert('Error refreshing AI analysis: ' + result.error, 'error');
                }
            } catch (error) {
                console.error('AI refresh error:', error);
                showAlert('Failed to refresh AI analysis. Please try again.', 'error');
            } finally {
                showLoading(false);
            }
        }

        // Legacy function for backward compatibility - now defaults to Notion refresh
        async function loadData() {
            await refreshNotionData();
        }

        function updateStats(stats) {
            if (!stats) return;
            
            document.getElementById('totalRecipes').textContent = stats.totalRecipes;
        }

        function processData() {
            renderRecipes();
            
            if (reviewData.length === 0) {
                document.getElementById('emptyState').style.display = 'block';
                document.getElementById('recipeContainer').style.display = 'none';
            } else {
                document.getElementById('emptyState').style.display = 'none';
                document.getElementById('recipeContainer').style.display = 'block';
            }
        }

        function renderRecipes() {
            const container = document.getElementById('recipeContainer');
            
            if (reviewData.length === 0) {
                container.innerHTML = '<div class="empty-state"><h3>No recipes match the filter</h3></div>';
                return;
            }

            container.innerHTML = reviewData.map(createRecipeCard).join('');
        }

        function createRecipeCard(item) {
            const confidence = item.analysis.confidence;
            const confidenceText = Math.round(confidence * 100) + '%';

            return `
                <div class="recipe-card" data-recipe-id="${item.recipe.id}">
                    <div class="recipe-header">
                        <h3 class="recipe-title">${item.recipe.name}</h3>
                        <span class="confidence-badge">${confidenceText}</span>
                    </div>
                    <div class="recipe-body">
                        <div class="recipe-details">
                            <p><strong>Source:</strong> <a href="${item.recipe.link}" target="_blank">${getDomain(item.recipe.link)}</a></p>
                        </div>
                        
                        ${createImageGallery(item)}
                        ${createComparisonGrid(item)}
                        
                        <div class="card-notification" id="notification-${item.recipe.id}"></div>
                        
                        <div class="recipe-actions">
                            <button class="btn btn-secondary" onclick="openRecipe('${item.recipe.url}')">📝 Edit in Notion</button>
                            <button class="btn btn-primary" onclick="resetFields('${item.recipe.id}')">🔄 Reset to AI Suggestions</button>
                            <button class="btn btn-success" onclick="saveChanges('${item.recipe.id}')">💾 Apply Changes</button>
                        </div>
                    </div>
                </div>
            `;
        }

        function createImageGallery(item) {
            const images = [];
            
            // Only add extracted images from the recipe website
            if (item.extractedData && item.extractedData.imageUrl) {
                images.push({
                    url: item.extractedData.imageUrl,
                    source: getDomain(item.recipe.link)
                });
            }
            
            // Look for additional images from the same recipe website
            const domain = getDomain(item.recipe.link);
            
            // For well-known recipe sites, try to find additional images
            if (domain.includes('recipetineats.com')) {
                const baseImageUrl = item.extractedData?.imageUrl;
                if (baseImageUrl) {
                    // Try variations like different sizes
                    const largeUrl = baseImageUrl.replace('206%2C206', '400%2C300');
                    if (largeUrl !== baseImageUrl) {
                        images.push({
                            url: largeUrl,
                            source: domain + ' (Large)'
                        });
                    }
                }
            }

            // Remove duplicates
            const uniqueImages = images.filter((img, index, arr) => 
                arr.findIndex(i => i.url === img.url) === index
            );

            const hasImages = uniqueImages.length > 0;
            const imageCountText = hasImages ? ` (${uniqueImages.length} found)` : '';

            return `
                <div class="image-section">
                    <h4>📷 Recipe Images${imageCountText}</h4>
                    
                    <div class="image-gallery">
                        ${hasImages ? uniqueImages.map((img, index) => `
                            <div class="image-option ${index === 0 ? 'selected' : ''}" 
                                 onclick="selectImage('${item.recipe.id}', ${index}, '${img.url}')"
                                 title="${index === 0 ? 'Click to unselect • From ' + img.source : 'Click to select • From ' + img.source}">
                                <img src="${img.url}" alt="Recipe image from ${img.source}" 
                                     onerror="this.parentElement.innerHTML='<div class=\\'placeholder\\'>Failed to load</div>'">
                                ${index === 0 ? '<div class="selected-badge">✓</div>' : ''}
                            </div>
                        `).join('') : `
                            <div class="image-option">
                                <div class="placeholder">No images found from ${domain}</div>
                            </div>
                        `}
                        
                        <div class="image-option upload-area" 
                             ondrop="handleImageDrop(event, '${item.recipe.id}')" 
                             ondragover="handleDragOver(event)" 
                             ondragleave="handleDragLeave(event)">
                            <input type="file" id="imageFile-${item.recipe.id}" accept="image/*" 
                                   onchange="handleImageFile(event, '${item.recipe.id}')" hidden>
                            <div class="upload-content" onclick="document.getElementById('imageFile-${item.recipe.id}').click()">
                                <span class="upload-icon">📁</span>
                                <span class="upload-text">Drop or Browse</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="url-input-section">
                        <div class="url-input-group">
                            <input type="url" class="image-url-input" id="imageUrl-${item.recipe.id}" 
                                   placeholder="Paste image URL here..." 
                                   onkeydown="if(event.key==='Enter') addImageFromUrl('${item.recipe.id}')">
                            <button class="add-image-btn" onclick="addImageFromUrl('${item.recipe.id}')">
                                Add Image URL
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function selectImage(recipeId, imageIndex, imageUrl) {
            // Check if clicking on already selected image (unselect)
            const currentSelection = selectedImages[recipeId];
            if (currentSelection && currentSelection.index === imageIndex) {
                // Unselect the image
                delete selectedImages[recipeId];
                
                // Update UI - remove all selections
                const card = document.querySelector(`[data-recipe-id="${recipeId}"]`);
                const imageOptions = card.querySelectorAll('.image-option');
                
                imageOptions.forEach((option) => {
                    option.classList.remove('selected');
                    const currentTitle = option.title || '';
                    const source = currentTitle.split('From ')[1] || 'unknown source';
                    option.title = `Click to select • From ${source}`;
                    const badge = option.querySelector('.selected-badge');
                    if (badge) {
                        badge.remove();
                    }
                });
                
                showCardNotification(recipeId, '🚫 Image unselected', 'info');
                return;
            }
            
            // Select new image
            selectedImages[recipeId] = { index: imageIndex, url: imageUrl };
            
            // Update UI
            const card = document.querySelector(`[data-recipe-id="${recipeId}"]`);
            const imageOptions = card.querySelectorAll('.image-option');
            
            imageOptions.forEach((option, index) => {
                const badge = option.querySelector('.selected-badge');
                const currentTitle = option.title || '';
                const source = currentTitle.split('From ')[1] || 'unknown source';
                
                if (index === imageIndex) {
                    option.classList.add('selected');
                    option.title = `Click to unselect • From ${source}`;
                    if (!badge) {
                        option.innerHTML += '<div class="selected-badge">✓</div>';
                    }
                } else {
                    option.classList.remove('selected');
                    option.title = `Click to select • From ${source}`;
                    if (badge) badge.remove();
                }
            });
            
            showCardNotification(recipeId, '✅ Image selected for cover', 'info');
        }

        function createComparisonGrid(item) {
            const current = item.recipe;
            const suggested = item.analysis;

            return `
                <div class="comparison-grid">
                    <div class="column current-column">
                        <h4>Current Values</h4>
                        ${createFieldDisplay('Title', current.name)}
                        ${createFieldDisplay('Meal Type', current.current_meal)}
                        ${createFieldDisplay('Cuisine', current.current_cuisine)}
                        ${createTagDisplay('Tags', current.current_tags)}
                        ${createTagDisplay('Key Ingredients', current.current_ingredients)}
                    </div>
                    
                    <div class="column suggested-column">
                        <h4>AI Suggestions</h4>
                        ${createFieldDisplay('Title', suggested.standardized_title)}
                        ${createFieldDisplay('Meal Type', suggested.meal)}
                        ${createFieldDisplay('Cuisine', suggested.cuisine)}
                        ${createTagDisplay('Tags', suggested.tags)}
                        ${createTagDisplay('Key Ingredients', suggested.key_ingredients)}
                    </div>
                    
                    <div class="column final-column">
                        <h4>Final Output</h4>
                        ${createEditableField('title', 'Title', suggested.standardized_title || current.name, item.recipe.id)}
                        ${createEditableSelect('meal', 'Meal Type', suggested.meal || current.current_meal, item.recipe.id, MEAL_OPTIONS)}
                        ${createEditableSelect('cuisine', 'Cuisine', suggested.cuisine || current.current_cuisine, item.recipe.id, CUISINE_OPTIONS)}
                        ${createEditableTagField('tags', 'Tags', suggested.tags || current.current_tags || [], item.recipe.id)}
                        ${createEditableTagField('keyIngredients', 'Key Ingredients', suggested.key_ingredients || current.current_ingredients || [], item.recipe.id)}
                    </div>
                </div>
            `;
        }

        function createFieldDisplay(label, value) {
            return `
                <div class="field-group">
                    <span class="field-label">${label}</span>
                    <div class="field-value ${!value ? 'empty' : ''}">${value || 'Empty'}</div>
                </div>
            `;
        }

        function createTagDisplay(label, tags) {
            return `
                <div class="field-group">
                    <span class="field-label">${label}</span>
                    <div class="field-value ${!tags || tags.length === 0 ? 'empty' : ''}">
                        ${tags && tags.length > 0 ? 
                            `<div class="tag-list">${tags.map(tag => `<span class="tag">${tag}</span>`).join('')}</div>` : 
                            'Empty'
                        }
                    </div>
                </div>
            `;
        }
        
        function createTextDisplay(label, text) {
            return `
                <div class="field-group">
                    <span class="field-label">${label}</span>
                    <div class="field-value text-value ${!text || text.trim() === '' ? 'empty' : ''}">${text ? text.replace(/\n/g, '<br>') : 'Empty'}</div>
                </div>
            `;
        }

        function createEditableField(fieldName, label, value, recipeId) {
            return `
                <div class="field-group">
                    <span class="field-label">${label}</span>
                    <input type="text" class="field-value" id="${fieldName}-${recipeId}" value="${value || ''}" 
                           style="border: 1px solid #e9e9e7; padding: 6px; border-radius: 4px; width: 100%;">
                </div>
            `;
        }

        function createEditableSelect(fieldName, label, value, recipeId, options) {
            return `
                <div class="field-group">
                    <span class="field-label">${label}</span>
                    <select class="field-value" id="${fieldName}-${recipeId}" 
                            style="border: 1px solid #e9e9e7; padding: 6px; border-radius: 4px; width: 100%;">
                        <option value="">Not Set</option>
                        ${options.map(opt => `<option value="${opt}" ${opt === value ? 'selected' : ''}>${opt}</option>`).join('')}
                    </select>
                </div>
            `;
        }

        function createEditableTagField(fieldName, label, tags, recipeId) {
            return `
                <div class="field-group">
                    <span class="field-label">${label}</span>
                    <div class="field-value">
                        <div class="tag-list" id="${fieldName}-display-${recipeId}">
                            ${tags.map(tag => `<span class="tag">${tag}</span>`).join('')}
                        </div>
                        <input type="text" placeholder="Add ${label.toLowerCase()}..." 
                               style="border: 1px solid #e9e9e7; padding: 4px; border-radius: 4px; width: 100%; margin-top: 4px; font-size: 0.75rem;"
                               onkeydown="handleTagInput(event, '${fieldName}', '${recipeId}')">
                    </div>
                    <input type="hidden" id="${fieldName}-${recipeId}" value="${tags.join(',')}">
                </div>
            `;
        }

        function createEditableTextArea(fieldName, label, value, recipeId) {
            return `
                <div class="field-group">
                    <span class="field-label">${label}</span>
                    <textarea class="field-value" id="${fieldName}-${recipeId}" 
                              style="border: 1px solid #e9e9e7; padding: 8px; border-radius: 4px; width: 100%; min-height: 100px; resize: vertical; font-family: inherit; font-size: 0.875rem;"
                              placeholder="Enter ${label.toLowerCase()}...">${value || ''}</textarea>
                </div>
            `;
        }




        function handleTagInput(event, fieldName, recipeId) {
            if (event.key === 'Enter' || event.key === ',') {
                event.preventDefault();
                const input = event.target;
                const tag = input.value.trim();
                
                if (tag) {
                    addTagToField(fieldName, recipeId, tag);
                    input.value = '';
                }
            }
        }

        function addTagToField(fieldName, recipeId, tag) {
            const hiddenInput = document.getElementById(`${fieldName}-${recipeId}`);
            const display = document.getElementById(`${fieldName}-display-${recipeId}`);
            
            const currentTags = hiddenInput.value ? hiddenInput.value.split(',') : [];
            if (!currentTags.includes(tag)) {
                currentTags.push(tag);
                hiddenInput.value = currentTags.join(',');
                
                // Update display
                display.innerHTML = currentTags.map(t => `<span class="tag">${t}</span>`).join('');
            }
        }

        function resetFields(recipeId) {
            const recipe = reviewData.find(item => item.recipe.id === recipeId);
            if (!recipe) return;
            
            const analysis = recipe.analysis;
            
            // Reset all fields to AI suggestions
            if (document.getElementById(`title-${recipeId}`)) {
                document.getElementById(`title-${recipeId}`).value = analysis.standardized_title || recipe.recipe.name;
            }
            if (document.getElementById(`meal-${recipeId}`)) {
                document.getElementById(`meal-${recipeId}`).value = analysis.meal || '';
            }
            if (document.getElementById(`cuisine-${recipeId}`)) {
                document.getElementById(`cuisine-${recipeId}`).value = analysis.cuisine || '';
            }
            
            // Reset tags
            const tagsInput = document.getElementById(`tags-${recipeId}`);
            const tagsDisplay = document.getElementById(`tags-display-${recipeId}`);
            if (analysis.tags && tagsInput && tagsDisplay) {
                tagsInput.value = analysis.tags.join(',');
                tagsDisplay.innerHTML = analysis.tags.map(tag => `<span class="tag">${tag}</span>`).join('');
            }
            
            // Reset ingredients
            const ingredientsInput = document.getElementById(`ingredients-${recipeId}`);
            const ingredientsDisplay = document.getElementById(`ingredients-display-${recipeId}`);
            if (analysis.key_ingredients && ingredientsInput && ingredientsDisplay) {
                ingredientsInput.value = analysis.key_ingredients.join(',');
                ingredientsDisplay.innerHTML = analysis.key_ingredients.map(ing => `<span class="tag">${ing}</span>`).join('');
            }
            
            showAlert('✅ Fields reset to AI suggestions!', 'success');
        }

        async function saveChanges(recipeId) {
            const recipe = reviewData.find(item => item.recipe.id === recipeId);
            if (!recipe) return;
            
            try {
                showLoading(true, 'Saving changes to Notion...');
                showCardNotification(recipeId, '💾 Saving changes to Notion...', 'info');
                
                // Collect all field values
                const updates = {};
                
                // Get title
                const titleEl = document.getElementById(`title-${recipeId}`);
                if (titleEl && titleEl.value.trim()) {
                    updates.title = titleEl.value.trim();
                }
                
                // Get meal
                const mealEl = document.getElementById(`meal-${recipeId}`);
                if (mealEl && mealEl.value) {
                    updates.meal = mealEl.value;
                }
                
                // Get cuisine
                const cuisineEl = document.getElementById(`cuisine-${recipeId}`);
                if (cuisineEl && cuisineEl.value) {
                    updates.cuisine = cuisineEl.value;
                }
                
                // Get tags
                const tagsEl = document.getElementById(`tags-${recipeId}`);
                if (tagsEl && tagsEl.value) {
                    updates.tags = tagsEl.value.split(',').map(tag => tag.trim()).filter(tag => tag);
                }
                
                // Get key ingredients
                const keyIngredientsEl = document.getElementById(`keyIngredients-${recipeId}`);
                if (keyIngredientsEl && keyIngredientsEl.value) {
                    updates.keyIngredients = keyIngredientsEl.value.split(',').map(ing => ing.trim()).filter(ing => ing);
                }
                
                
                console.log('DEBUG - Final updates object:', Object.keys(updates));
                
                // Get selected image
                const selectedImage = selectedImages[recipeId];
                if (selectedImage && selectedImage.url) {
                    updates.selectedImage = selectedImage.url;
                }
                
                // Send update request
                const response = await fetch('/api/enrichment', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'updateRecipe',
                        recipeId: recipeId,
                        updates: updates
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showCardNotification(recipeId, '✅ Changes saved to Notion successfully!', 'success');
                } else {
                    showCardNotification(recipeId, `❌ Error saving changes: ${result.error}`, 'error');
                }
                
            } catch (error) {
                console.error('Save error:', error);
                showCardNotification(recipeId, '❌ Failed to save changes', 'error');
            } finally {
                showLoading(false);
            }
        }

        function openRecipe(url) {
            window.open(url, '_blank');
        }

        function openNotion() {
            window.open(NOTION_DATABASE_URL, '_blank');
        }

        function showLoading(show, message = 'Loading...') {
            const loading = document.getElementById('loading');
            if (show) {
                loading.style.display = 'block';
                loading.querySelector('p').textContent = message;
            } else {
                loading.style.display = 'none';
            }
        }

        function showAlert(message, type = 'info') {
            const alert = document.getElementById('alert');
            alert.style.display = 'block';
            alert.textContent = message;
            alert.className = `alert ${type}`;
            
            setTimeout(() => hideAlert(), 5000);
        }

        function hideAlert() {
            document.getElementById('alert').style.display = 'none';
        }

        function showCardNotification(recipeId, message, type = 'info') {
            const notification = document.getElementById(`notification-${recipeId}`);
            if (notification) {
                notification.textContent = message;
                notification.className = `card-notification ${type}`;
                notification.style.display = 'block';
                
                // Auto-hide after 5 seconds
                setTimeout(() => hideCardNotification(recipeId), 5000);
            }
        }

        function hideCardNotification(recipeId) {
            const notification = document.getElementById(`notification-${recipeId}`);
            if (notification) {
                notification.style.display = 'none';
            }
        }

        function getDomain(url) {
            try {
                return new URL(url).hostname.replace('www.', '');
            } catch {
                return url.substring(0, 30) + '...';
            }
        }

        function handleDragOver(event) {
            event.preventDefault();
            event.currentTarget.classList.add('dragover');
        }

        function handleDragLeave(event) {
            event.preventDefault();
            event.currentTarget.classList.remove('dragover');
        }

        function handleImageDrop(event, recipeId) {
            event.preventDefault();
            event.currentTarget.classList.remove('dragover');
            
            const files = event.dataTransfer.files;
            if (files.length > 0 && files[0].type.startsWith('image/')) {
                handleImageFile({target: {files: files}}, recipeId);
            }
        }

        function handleImageFile(event, recipeId) {
            const file = event.target.files[0];
            if (!file) return;
            
            // Create a local URL for the uploaded image
            const imageUrl = URL.createObjectURL(file);
            addCustomImage(recipeId, imageUrl, 'Uploaded File');
            
            showAlert('✅ Image uploaded successfully!', 'success');
        }

        function addImageFromUrl(recipeId) {
            const urlInput = document.getElementById(`imageUrl-${recipeId}`);
            const imageUrl = urlInput.value.trim();
            
            if (!imageUrl) {
                showAlert('Please enter an image URL', 'error');
                return;
            }
            
            if (!isValidImageUrl(imageUrl)) {
                showAlert('Please enter a valid image URL', 'error');
                return;
            }
            
            addCustomImage(recipeId, imageUrl, 'Custom URL');
            urlInput.value = '';
            showAlert('✅ Image added successfully!', 'success');
        }

        function addCustomImage(recipeId, imageUrl, source) {
            // Find the recipe card
            const card = document.querySelector(`[data-recipe-id="${recipeId}"]`);
            const gallery = card.querySelector('.image-gallery');
            
            // Create new image option
            const newIndex = gallery.querySelectorAll('.image-option').length;
            const imageOption = document.createElement('div');
            imageOption.className = 'image-option';
            imageOption.onclick = () => selectImage(recipeId, newIndex, imageUrl);
            imageOption.title = `From ${source}`;
            imageOption.innerHTML = `
                <img src="${imageUrl}" alt="Custom image from ${source}" 
                     onerror="this.parentElement.innerHTML='<div class=\\'placeholder\\'>Failed to load</div>'">
            `;
            
            // Insert before upload area (if it's in the gallery)
            gallery.appendChild(imageOption);
            
            // Auto-select the new image
            selectImage(recipeId, newIndex, imageUrl);
        }

        function isValidImageUrl(url) {
            try {
                const validUrl = new URL(url);
                return validUrl.protocol === 'http:' || validUrl.protocol === 'https:';
            } catch {
                return false;
            }
        }

        // Interactive functions for structured recipe components



    </script>
</body>
</html>